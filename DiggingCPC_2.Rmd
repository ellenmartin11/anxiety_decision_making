---
title: "CPC Poster Code"
author: "Ellen Martin"
date: "`r Sys.Date()`"
output: html_document
---

# CPC Poster Code
## Preparing Files and Data
```{r Libraries}
library(readr)
library(NatParksPalettes)
library(ggplot2)
library(Hmisc) #for computing correlation stuff
library(knitr) 
library(tidyverse, warn.conflict=F)
library(corrplot)
library(dplyr)
library(MASS)
library(sandwich)
library(lmtest)
library(broom)
library(dplyr)
library(gt)
library(lme4)
library(dunn.test)

source("poster_theme.R") #for figure themes
source("functions/process_initquiz.R")
source("functions/process_digging_long.R")
source("functions/process_params.R")
source("functions/softmax.R")


```

```{r Data Paths}
data_path <- "C:\\Users\\Ellen Martin\\OneDrive\\Desktop\\Rutledge Lab\\ApathyDepression\\updatedData\\data\\happyData\\"

# plays one and two for people with at least two plays
onetwo_long_file <- paste0(data_path,"THP_uk_DiggingHappy2_n2445.csv")


# parameters and model fits data
happy_file_multi <- paste0(data_path, "modelBased\\happy_params4_onetwo_n2243.csv")

# survey data
survey_file <- paste0("C:\\Users\\Ellen Martin\\OneDrive\\Desktop\\Rutledge Lab\\ApathyDepression\\updatedData\\analyses\\uk_general_survey.csv")

# initial quiz data
initquiz_file <- paste0(data_path, "THP_uk_initquiz.csv")

# non-backfilled happiness data
rsd_data <- paste0(data_path, "THP_rsd.csv")

```


```{r Data Paths (plays 2 and 3)}

# plays two and three for people with at least three plays
twothree_long_file <- paste0(data_path,"THP_uk_DiggingHappy3_n1035.csv")
happy_file_twothree <- paste0(data_path, "modelBased\\happy_params4_twothree_n998.csv")
survey_file <- paste0("C:\\Users\\Ellen Martin\\OneDrive\\Desktop\\Rutledge Lab\\ApathyDepression\\updatedData\\analyses\\uk_general_survey.csv")

# initial quiz data
initquiz_file <- paste0(data_path, "THP_uk_initquiz.csv")

rsd_data_twothree <- paste0(data_path, "THP_rsd_twothree.csv")

```

```{r Cleaning and Merging Data}

T_initquiz <- process_initquiz(initquiz_file)
length(unique(T_initquiz$userKey))

T_digging_long <- process_digging_long(onetwo_long_file)
length(unique(T_digging_long$userKey)) #2243


# survey data
T_digging_long <- process_survey_data(T_digging_long,survey_file)
length(unique(T_digging_long$userKey)) #1975

# happiness model parameters
T_digging_long <- process_params(T_digging_long,happy_file_multi)
length(unique(T_digging_long$userKey)) #1975
head(T_digging_long)


happyData12 <- T_digging_long
length(unique(happyData12$userKey)) #1975


rsd_data <- read.csv(rsd_data)
rsd_data$HappyRating <- rsd_data$HappyRating*100

happyData12 <- merge(happyData12,rsd_data,by=c("userKey","TrialNumber","PlayNo"))
happyData12 <- merge(happyData12, T_initquiz, by="userKey")


happyData12 <- happyData12 %>%
    group_by(userKey) %>%
    mutate(zHappyRating = as.numeric(scale(HappyRating, center=TRUE,scale=TRUE))) %>%
    ungroup()

length(unique(happyData12$userKey)) #1464

```

```{r Cleaning and Merging Data: Plays 2 and 3}

T_initquiz <- process_initquiz(initquiz_file)
length(unique(T_initquiz$userKey))



T_digging_long <- process_digging_long(twothree_long_file)
length(unique(T_digging_long$userKey)) #919

# survey data
T_digging_long <- process_survey_data(T_digging_long,survey_file)
length(unique(T_digging_long$userKey)) 



T_digging_long <- process_params(T_digging_long,happy_file_twothree)
length(unique(T_digging_long$userKey)) 
head(T_digging_long)



happyData23 <- T_digging_long
length(unique(happyData23$userKey)) 


rsd_data <- read.csv(rsd_data_twothree)
rsd_data$HappyRating <- rsd_data$HappyRating*100
happyData23 <- merge(happyData23,rsd_data,by=c("userKey","TrialNumber","PlayNo"))
happyData23 <- merge(happyData23, T_initquiz, by="userKey")

length(unique(happyData23$userKey)) #655
```


## Summary of Happiness Data, GAD and PHQ
```{r GAD, PHQ and Distribution Plots}


# returns PHQ-GAD correlation and distribution of raw happiness ratings (based on play)
# play 1 and play 2 plots will be the same for now, since it's the same set of participants
play1_plot <- calc_rGADPHQ(happyData12,1)

play1_plot$plot #GAD-PHQ Correlation
play1_plot$dist_plot #happiness distribution
play1_plot$plot2 #mean against SD Happiness

play2_plot <- calc_rGADPHQ(happyData12,2)
play2_plot$dist_plot
play2_plot$plot2

median(happyData12$phq8_total)
median(happyData12$gad7_total,na.rm=TRUE)

gender_count <- happyData12 %>%
  group_by(userKey) %>%
  summarise(Gender = first(gender_group)) %>%
  ungroup() %>%
  summarise(
    num_males = sum(Gender == "Male", na.rm = TRUE),
    num_females = sum(Gender == "Female", na.rm = TRUE)
  )

# Print the result
print(gender_count)


age <- happyData12 %>%
  group_by(userKey) %>%
  summarize(age = first(age_bin)) %>%
  mutate(age = factor(age, levels = c("Below 25", "25-34", "35-44", "45-54", "55-64", "65+")))

ggplot(age,aes(x=age)) + 
  geom_histogram(stat="count",fill="lightblue",color="black") + 
  theme_minimal() + 
  ggtitle("Age Distribution (N=1465)")

risky_data <- happyData12 %>%
    group_by(userKey, Trial) %>%
    summarise(total_choices = n(),
              risky_choices = sum(RiskChosen == 2, na.rm = TRUE),
              percent_risky = (risky_choices / total_choices) * 100,
              .groups = 'drop')

summary_data <- risky_data %>%
    group_by(Trial) %>%
    summarise(mean_percent_risky = mean(percent_risky, na.rm = TRUE),
              se_percent_risky = sd(percent_risky, na.rm = TRUE) / sqrt(n()),
              .groups = 'drop')
  
  ggplot(summary_data, aes(x = Trial, y = mean_percent_risky, fill = Trial)) +
    geom_bar(stat = "identity", width = 0.7, color = "black") +
    geom_errorbar(aes(ymin = mean_percent_risky - se_percent_risky, ymax = mean_percent_risky + se_percent_risky),
                  width = 0.2) +
    labs(
      title = "Mean % Risky Choices in Gain vs Loss Trials",
      x = "Trial Type",
      y = "% Risky Choices"
    ) +
    theme_minimal() +
    ylim(0, 60) +  
    poster_theme + 
    scale_fill_manual(values = c("Gain" = "gold", "Loss" = "coral"))
```
- the percentage of risky choices is generally higher, (in both gain and loss domain)

```{r}
# play 1 only
risky_data <- happyData12 %>%
  filter(PlayNo == 2) %>%
    group_by(userKey, Trial) %>%
    summarise(total_choices = n(),
              risky_choices = sum(RiskChosen == 2, na.rm = TRUE),
              percent_risky = (risky_choices / total_choices) * 100,
              .groups = 'drop')

summary_data <- risky_data %>%
    group_by(Trial) %>%
    summarise(mean_percent_risky = mean(percent_risky, na.rm = TRUE),
              se_percent_risky = sd(percent_risky, na.rm = TRUE) / sqrt(n()),
              .groups = 'drop')
  
  ggplot(summary_data, aes(x = Trial, y = mean_percent_risky, fill = Trial)) +
    geom_bar(stat = "identity", width = 0.7, color = "black") +
    geom_errorbar(aes(ymin = mean_percent_risky - se_percent_risky, ymax = mean_percent_risky + se_percent_risky),
                  width = 0.2) +
    labs(
      title = "Mean % Risky Choices in Gain vs Loss Trials",
      x = "Trial Type",
      y = "% Risky Choices"
    ) +
    theme_minimal() +
    ylim(0, 60) +  
    poster_theme + 
    scale_fill_manual(values = c("Gain" = "gold", "Loss" = "coral"))

```
# gambling higher in loss domain? 

## plays 2 and 3
```{r}
# returns PHQ-GAD correlation and distribution of raw happiness ratings (based on play)
# play 1 and play 2 plots will be the same for now, since it's the same set of participants
play1_plot <- calc_rGADPHQ(happyData23,2)

play1_plot$plot #GAD-PHQ Correlation
play1_plot$dist_plot #happiness distribution
play1_plot$plot2 #mean against SD Happiness

play2_plot <- calc_rGADPHQ(happyData23,3)
play2_plot$dist_plot
play2_plot$plot2

median(happyData23$phq8_total)
median(happyData23$gad7_total,na.rm=TRUE)

gender_count <- happyData23 %>%
  group_by(userKey) %>%
  summarise(Gender = first(gender_group)) %>%
  ungroup() %>%
  summarise(
    num_males = sum(Gender == "Male", na.rm = TRUE),
    num_females = sum(Gender == "Female", na.rm = TRUE)
  )

# Print the result
print(gender_count)

# Calculate the mean and SEM percentages for each condition
average_percentages_by_condition <- happyData23 %>%
  group_by(Trial) %>%
  summarise(
    Risk_Chosen_Mean = mean(RiskChosen == 2) * 100,
    Safe_Chosen_Mean = mean(RiskChosen == 1) * 100,
    Risk_Chosen_SEM = sd(RiskChosen == 2) / sqrt(n()) * 100,
    Safe_Chosen_SEM = sd(RiskChosen == 1) / sqrt(n()) * 100
  )

# Prepare data for plotting
average_percentages_long_by_condition <- average_percentages_by_condition %>%
  pivot_longer(cols = c(Risk_Chosen_Mean, Safe_Chosen_Mean), names_to = "Choice", values_to = "Percentage") %>%
  pivot_longer(cols = c(Risk_Chosen_SEM, Safe_Chosen_SEM), names_to = "SEM_Choice", values_to = "SEM") %>%
  filter(substr(Choice, 1, 4) == substr(SEM_Choice, 1, 4)) %>%
  mutate(Choice = recode(Choice, "Risk_Chosen_Mean" = "Risk Chosen", "Safe_Chosen_Mean" = "Safe Chosen"))

# Plot the bar plot with SEM error bars
ggplot(average_percentages_long_by_condition, aes(x = Choice, y = Percentage, fill = Trial)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(aes(ymin = Percentage - SEM, ymax = Percentage + SEM), position = position_dodge(width = 0.7), width = 0.2) +
  labs(title = "Average Percentages of Risks and Safe Choices by Trial",
       x = "Choice",
       y = "Percentage") +
  theme_minimal() +
  poster_theme

age <- happyData23 %>%
  group_by(userKey) %>%
  summarize(age = first(age_bin)) %>%
  mutate(age = factor(age, levels = c("Below 25", "25-34", "35-44", "45-54", "55-64", "65+")))

ggplot(age,aes(x=age)) + 
  geom_histogram(stat="count",fill="lightblue",color="black") + 
  theme_minimal() + 
  ggtitle("Age Distribution (N=655)")
```


## Correlations Between GAD/PHQ and Gambling Behaviour
```{r Correlation Between GAD, PHQ and Gambling Behaviour}

result_gain_one <- summarize_and_correlate(happyData12, 1, "Gain")
result_loss_one <- summarize_and_correlate(happyData12, 1, "Loss")

result_gain_two <- summarize_and_correlate(happyData12, 2, "Gain")
result_loss_two <- summarize_and_correlate(happyData12, 2, "Loss")

combined_results <- bind_rows(result_gain_one, result_loss_one, result_gain_two, result_loss_two)

combined_results %>%
  gt() %>%
  tab_header(
    title = "Correlation Between GAD/PHQ and % Risky Choices"
  ) %>%
  fmt_number(
    columns = vars(rho, p_value),
    decimals = 3
  )


```
- no correlation between GAD, PHQ and % of Risky Choices

## play 2 and 3

```{r}
result_gain_one <- summarize_and_correlate(happyData23, 2, "Gain")
result_loss_one <- summarize_and_correlate(happyData23, 2, "Loss")

result_gain_two <- summarize_and_correlate(happyData23, 3, "Gain")
result_loss_two <- summarize_and_correlate(happyData23, 3, "Loss")

combined_results <- bind_rows(result_gain_one, result_loss_one, result_gain_two, result_loss_two)

combined_results %>%
  gt() %>%
  tab_header(
    title = "Correlation Between GAD/PHQ and % Risky Choices"
  ) %>%
  fmt_number(
    columns = vars(rho, p_value),
    decimals = 3
  )

# only a correlation between PHQ and % Risky choices in Loss domain (p=0.039)
```

### Gender and Age Differences in Gambling Behaviour 

```{r}
## insert here code to calculate % risky choices in gain and loss trials split by age (do binned ages, and one line for gain gambling and another line for loss gambling)

## also do another plot showing % risky choices in gain trials (two different lines for genders), and in loss trials (same)
```


## Correlation Between GAD/PHQ and SD Happiness
```{r Correlation Between GAD/PHQ and SD Happiness}

result_gain_one_sd <- summarize_and_correlate_happiness(happyData12, 1, "Gain")
result_loss_one_sd <- summarize_and_correlate_happiness(happyData12, 1, "Loss")
result_gain_two_sd <- summarize_and_correlate_happiness(happyData12, 2, "Gain")
result_loss_two_sd <- summarize_and_correlate_happiness(happyData12, 2, "Loss")
result_overall_one_sd <- summarize_and_correlate_happiness(happyData12,1, overall=TRUE)
result_overall_two_sd <- summarize_and_correlate_happiness(happyData12,2,overall=TRUE)



combined_results <- bind_rows(result_gain_one_sd, result_loss_one_sd, result_gain_two_sd, result_loss_two_sd,result_overall_one_sd,result_overall_two_sd)

combined_results %>%
  gt() %>%
  tab_header(
    title = "Correlation Between GAD/PHQ and SD Happiness"
  ) %>%
  fmt_number(
    columns = vars(rho, p_value),
    decimals = 3
  )


# z-scored happiness and GAD/PHQ no association
result_gain_one_zHappy <- summarize_and_correlate_z_happiness(happyData12, 1, "Gain")
result_loss_one_zHappy<- summarize_and_correlate_z_happiness(happyData12, 1, "Loss")
result_gain_two_zHappy <- summarize_and_correlate_z_happiness(happyData12, 2, "Gain")
result_loss_two_zHappy<- summarize_and_correlate_z_happiness(happyData12, 2, "Loss")
result_overall_one_zHappy <- summarize_and_correlate_z_happiness(happyData12,1, overall=TRUE)
result_overall_two_zHappy <- summarize_and_correlate_z_happiness(happyData12,2,overall=TRUE)

combined_results <- bind_rows(result_gain_one_zHappy, result_loss_one_zHappy, result_gain_two_zHappy, result_loss_two_zHappy,result_overall_one_zHappy,result_overall_two_zHappy)

combined_results %>%
  gt() %>%
  tab_header(
    title = "Correlation Between GAD/PHQ and z-scored Happiness"
  ) %>%
  fmt_number(
    columns = vars(rho, p_value),
    decimals = 3
  )

```
 - GAD associated with SD Happiness in Play 1
 
 ## play 2 and 3
```{r}
result_gain_one_sd <- summarize_and_correlate_happiness(happyData23, 2, "Gain")
result_loss_one_sd <- summarize_and_correlate_happiness(happyData23, 2, "Loss")
result_gain_two_sd <- summarize_and_correlate_happiness(happyData23, 3, "Gain")
result_loss_two_sd <- summarize_and_correlate_happiness(happyData23, 3, "Loss")
result_overall_one_sd <- summarize_and_correlate_happiness(happyData23,2, overall=TRUE)
result_overall_two_sd <- summarize_and_correlate_happiness(happyData23,3,overall=TRUE)



combined_results <- bind_rows(result_gain_one_sd, result_loss_one_sd, result_gain_two_sd, result_loss_two_sd,result_overall_one_sd,result_overall_two_sd)

combined_results %>%
  gt() %>%
  tab_header(
    title = "Correlation Between GAD/PHQ and SD Happiness"
  ) %>%
  fmt_number(
    columns = vars(rho, p_value),
    decimals = 3
  )

# association between SD Happiness and GAD no longer there - suggests it's an effect unique to first play
```
 

### Plots of GAD/PHQ Against SD Happines
```{r SD and Symptom Score Plots}
# EDIT THIS CODE SO IT IS MORE SEPARATE INTO OVERALL AND INTO LOSS TRIALS, AND FIGURE OUT WHY THE PLOT IS MESSING UP
play1_data <- summarize_play_data(happyData12, 1)
play2_data <- summarize_play_data(happyData12,2)

plot_gad_sd(play1_data, play2_data)
plot_gad_sd_loss(play1_data, play2_data)
plot_gad_rsd(play1_data, play2_data)
plot_gad_rsd_loss(play1_data, play2_data)

plot_phq_sd(play1_data, play2_data)
plot_phq_sd_loss(play1_data, play2_data)

plot_phq_rsd(play1_data, play2_data)
plot_phq_rsd_loss(play1_data, play2_data)

```
- Appears to be a stronger association between SD Happiness and GAD compared to SD Happiness and PHQ
- Effect is also consistent for Relative SD (the values are a proportion)

## Play 2 and 3
```{r}
# EDIT THIS CODE SO IT IS MORE SEPARATE INTO OVERALL AND INTO LOSS TRIALS, AND FIGURE OUT WHY THE PLOT IS MESSING UP
play1_data <- summarize_play_data(happyData23, 2)
play2_data <- summarize_play_data(happyData23,3)

plot_gad_sd(play1_data, play2_data)
plot_gad_sd_loss(play1_data, play2_data)
plot_gad_rsd(play1_data, play2_data)
plot_gad_rsd_loss(play1_data, play2_data)

plot_phq_sd(play1_data, play2_data)
plot_phq_sd_loss(play1_data, play2_data)

plot_phq_rsd(play1_data, play2_data)
plot_phq_rsd_loss(play1_data, play2_data)
```


## Robust Linear Models 
- Predicting GAD from SD Happiness 

```{r Robust Linear Regression}

play1 <- summarize_play_data(happyData12,1) %>% mutate(PlayNo = 1)
play2 <- summarize_play_data(happyData12,2) %>% mutate(PlayNo = 2)

# predicting GAD from SD Happiness in Play 1
rlm <- rlm(GAD_score~sd_RawHappy,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

# predicting GAD from rsd Happiness in Play 1
rlm <- rlm(GAD_score~rsd_RawHappy,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 


# predicting PHQ from SD Happiness
rlm_PHQ <- rlm(PHQ_score~sd_RawHappy,data=play1)
robust_se <- vcovHC(rlm_PHQ, type = "HC0")
coeftest(rlm_PHQ, robust_se) 

# predicting PHQ from RSD
rlm_PHQ <- rlm(PHQ_score~rsd_RawHappy,data=play1)
robust_se <- vcovHC(rlm_PHQ, type = "HC0")
coeftest(rlm_PHQ, robust_se) 

# predicting GAD from SD Happiness + Mean Happiness in Play 1
rlm1 <- rlm(GAD_score~mean_RawHappy+sd_RawHappy,data=play1)
robust_se <- vcovHC(rlm1, type = "HC0")
coeftest(rlm1, robust_se) 

# predicting GAD from RSD Happiness + mean Happiness in Play 1
rlm1 <- rlm(GAD_score~mean_RawHappy+rsd_RawHappy,data=play1)
robust_se <- vcovHC(rlm1, type = "HC0")
coeftest(rlm1, robust_se) 

# predicting PHQ from SD Happiness + mean Happiness in Play 1
rlm1_PHQ <- rlm(PHQ_score~mean_RawHappy+sd_RawHappy,data=play1)
robust_se <- vcovHC(rlm1_PHQ, type = "HC0")
coeftest(rlm1_PHQ, robust_se) 


# predicting PHQ from RSD Happiness + mean Happiness in Play 1
rlm2_PHQ <- rlm(PHQ_score~mean_RawHappy+rsd_RawHappy,data=play1)
robust_se <- vcovHC(rlm2_PHQ, type = "HC0")
coeftest(rlm2_PHQ, robust_se) 

```

## Robust Linear Regression - Predicting GAD from SD Happiness in Loss Domains

```{r Robust Linear Regression - Loss Domain SD Happy}
# predicting GAD from SD Happiness in Play 1
rlm <- rlm(GAD_score~sd_RawHappy_loss,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(GAD_score~rsd_RawHappy_loss,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~sd_RawHappy_loss,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~rsd_RawHappy_loss,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 


# predicting GAD from SD Happiness in Play 2
rlm <- rlm(GAD_score~sd_RawHappy_loss,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(GAD_score~rsd_RawHappy_loss,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~sd_RawHappy_loss,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~rsd_RawHappy_loss,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 


# taking into account mean happiness overall
rlm <- rlm(GAD_score~sd_RawHappy_loss+mean_RawHappy,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(GAD_score~rsd_RawHappy_loss+mean_RawHappy,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~sd_RawHappy_loss+mean_RawHappy,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~rsd_RawHappy_loss+mean_RawHappy,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

# play2 
# taking into account mean happiness overall
rlm <- rlm(GAD_score~sd_RawHappy_loss+mean_RawHappy,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(GAD_score~rsd_RawHappy_loss+mean_RawHappy,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~sd_RawHappy_loss+mean_RawHappy,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~rsd_RawHappy_loss+mean_RawHappy,data=play2)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 
```

## Taking into account age and education

```{r Age and Education}
play1 <- merge(play1, T_initquiz, by="userKey")

rlm <- rlm(GAD_score~sd_RawHappy_loss+mean_RawHappy+age+education,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(GAD_score~rsd_RawHappy_loss+mean_RawHappy+age+education,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~sd_RawHappy_loss+mean_RawHappy+age+education,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

rlm <- rlm(PHQ_score~rsd_RawHappy_loss+mean_RawHappy+age+education,data=play1)
robust_se <- vcovHC(rlm, type = "HC0")
coeftest(rlm, robust_se) 

# sd happiness not predictive of GAD or PHQ when accounting for mean happiness + age + education in Play 1
```

## Parameters 
- EV and RPE plot

```{r Happiness Model Parameters}
play1_stats <- happyData12 %>%
  filter(PlayNo == 1) %>%
  group_by(userKey) %>%
  summarize(sd_RawHappy_play1 = sd(RawHappy, na.rm = TRUE),
            mean_RawHappy_play1 = mean(RawHappy, na.rm = TRUE),
            rsd_RawHappy_play1 = relSD_tc(HappyRating * 100, 0, 100)
            )

play2_stats <- happyData12 %>%
  filter(PlayNo == 2) %>%
  group_by(userKey) %>%
  summarize(sd_RawHappy_play2 = sd(RawHappy, na.rm = TRUE),
            mean_RawHappy_play2 = mean(RawHappy, na.rm = TRUE),
            rsd_RawHappy_play2 = relSD_tc(HappyRating * 100, 0, 100)
            )

combined_stats <- happyData12 %>%
  group_by(userKey) %>%
  summarize(GAD = first(gad7_total),
            PHQ = first(phq8_total),
            sse_multi = first(sse_multi),
            rpe_chosen_multi = first(rpe_chosen_multi),
            abs_rpe = abs(rpe_chosen_multi),
            r2_multi = first(r2_multi),
            aic_multi = first(aic_multi),
            bic_multi = first(bic_multi),
            tau_multi = first(tau_multi),
            age=first(age),
            gender = first(gender_group),
            education = first(education),
            const1_multi = first(const1_multi),
            const1_scaled = (const1_multi / 100),
            ev_multi = first(ev_chosen_multi),
            abs_ev = abs(ev_multi),
            const2_multi = first(const2_multi),
            rpe_ev_d = (rpe_chosen_multi - ev_multi)) %>%
  mutate(GAD_group = ifelse(GAD >= 6, "GAD 6+", "GAD < 6"),
         PHQ_group = ifelse(PHQ >= 7, "PHQ 7+", "PHQ < 7")) %>%
  na.omit()

# Merge the play-specific statistics back into the combined statistics
final_summary <- combined_stats %>%
  left_join(play1_stats, by = "userKey") %>%
  left_join(play2_stats, by = "userKey")

final_summary <- final_summary %>%
  mutate(sd_RawHappy = (sd_RawHappy_play1+sd_RawHappy_play2)/2,
            mean_RawHappy = (mean_RawHappy_play1+mean_RawHappy_play2)/2)
      
        #,rsd_RawHappy = (rsd_RawHappy_play1 + rsd_RawHappy_play2)/2)

final_summary <- final_summary  %>%
  mutate(
    GAD_bin = cut(GAD, breaks = c(-Inf, 4, 9, 14, 21), labels = c("0-4", "5-9", "10-14", "15-21")),
    PHQ_bin = cut(PHQ, breaks = c(-Inf, 4, 9, 14, 24), labels = c("0-4", "5-9", "10-14", "15-24"))
  )

# plotting
plot_happiness_model_parameters(happyData12)
plot_happiness_model_parameters_all(happyData12)
```

## Play 2 and 3
```{r}
play1_stats <- happyData23 %>%
  filter(PlayNo == 2) %>%
  group_by(userKey) %>%
  summarize(sd_RawHappy_play1 = sd(RawHappy, na.rm = TRUE),
            mean_RawHappy_play1 = mean(RawHappy, na.rm = TRUE),
            rsd_RawHappy_play1 = relSD_tc(HappyRating * 100, 0, 100)
            )

play2_stats <- happyData23 %>%
  filter(PlayNo == 3) %>%
  group_by(userKey) %>%
  summarize(sd_RawHappy_play2 = sd(RawHappy, na.rm = TRUE),
            mean_RawHappy_play2 = mean(RawHappy, na.rm = TRUE),
            rsd_RawHappy_play2 = relSD_tc(HappyRating * 100, 0, 100)
            )

combined_stats <- happyData23 %>%
  group_by(userKey) %>%
  summarize(GAD = first(gad7_total),
            PHQ = first(phq8_total),
            sse_multi = first(sse_multi),
            rpe_chosen_multi = first(rpe_chosen_multi),
            abs_rpe = abs(rpe_chosen_multi),
            r2_multi = first(r2_multi),
            aic_multi = first(aic_multi),
            bic_multi = first(bic_multi),
            tau_multi = first(tau_multi),
            age=first(age),
            gender = first(gender_group),
            education = first(education),
            const1_multi = first(const1_multi),
            const1_scaled = (const1_multi / 100),
            ev_multi = first(ev_chosen_multi),
            abs_ev = abs(ev_multi),
            const2_multi = first(const2_multi),
            rpe_ev_d = (rpe_chosen_multi - ev_multi)) %>%
  mutate(GAD_group = ifelse(GAD >= 5, "GAD 5+", "GAD < 5"),
         PHQ_group = ifelse(PHQ >= 7, "PHQ 7+", "PHQ < 7")) %>%
  na.omit()

# Merge the play-specific statistics back into the combined statistics
final_summary <- combined_stats %>%
  left_join(play1_stats, by = "userKey") %>%
  left_join(play2_stats, by = "userKey")

final_summary <- final_summary %>%
  mutate(sd_RawHappy = (sd_RawHappy_play1+sd_RawHappy_play2)/2,
            mean_RawHappy = (mean_RawHappy_play1+mean_RawHappy_play2)/2)
      
        #,rsd_RawHappy = (rsd_RawHappy_play1 + rsd_RawHappy_play2)/2)

final_summary <- final_summary  %>%
  mutate(
    GAD_bin = cut(GAD, breaks = c(-Inf, 4, 9, 14, 21), labels = c("0-4", "5-9", "10-14", "15-21")),
    PHQ_bin = cut(PHQ, breaks = c(-Inf, 4, 9, 14, 24), labels = c("0-4", "5-9", "10-14", "15-24"))
  )

# plotting
plot_happiness_model_parameters(happyData23)
plot_happiness_model_parameters_all(happyData23)
```

### Happiness Model Parameters Split by Groups

```{r Parameters Split By Groups}
plot_summary_stats(final_summary,"GAD_group")
plot_summary_stats(final_summary,"PHQ_group")
plot_summary_stats(final_summary,"gender")

cor.test(final_summary$GAD,final_summary$abs_rpe,method="spearman")
cor.test(final_summary$GAD,final_summary$rpe_chosen_multi,method="spearman")

cor.test(final_summary$GAD,final_summary$abs_ev,method="spearman")
cor.test(final_summary$GAD,final_summary$ev_multi,method="spearman")

cor.test(final_summary$PHQ,final_summary$abs_rpe,method="spearman")
cor.test(final_summary$PHQ,final_summary$rpe_chosen_multi,method="spearman")

cor.test(final_summary$PHQ,final_summary$abs_ev,method="spearman")
cor.test(final_summary$PHQ,final_summary$ev_multi,method="spearman")

cor.test(final_summary$abs_rpe,final_summary$sd_RawHappy,method="spearman")
cor.test(final_summary$rpe_chosen_multi,final_summary$sd_RawHappy,method="spearman")

```
- RPE is higher among people with higher GAD

### Distribution of Happiness Parameters

```{r}
variable_names <- c("tau_multi", "ev_multi", "rpe_chosen_multi", "const1_multi","abs_ev","abs_rpe")

for (var_name in variable_names) {
  p <- ggplot(final_summary, aes_string(x = var_name)) +
    geom_histogram(bins = 30, fill = "lightblue", color = "black") +
    labs(title = paste("Histogram of", var_name), x = var_name, y = "Frequency") +
    theme_minimal()
  print(p)
}
```

## Mood After Win-Lose (Correlated with Depression/Anxiety)



```{r Gain Domain, Risky Choice, Win vs Lose Happiness}
play1 <- happyData12 %>% filter(PlayNo == 1)
play2 <- happyData12 %>% filter(PlayNo == 2)


result <- winvloss_happy(happyData12, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test 

#z-scored
result <- winvloss_z_happy(happyData12, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test 


result <- winvloss_happy_GAD(happyData12, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus
result$wilcox_test_gad_less6

#z-scored GAD 

result <- winvloss_z_happy_GAD(happyData12, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus
result$wilcox_test_gad_less6 


# play 1
result <- winvloss_happy(play1, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test 


result <- winvloss_happy_GAD(play1, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus
result$wilcox_test_gad_less6 

# play 2
result <- winvloss_happy(play2, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test 


result <- winvloss_happy_GAD(play2, "Gain", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus
result$wilcox_test_gad_less6 
```
- there is slightly elevated happiness for LOSING risky choices in Gain Domains versus WINNING risky choices in Gain Domains - and this is not what the model predicts (model predicts higher mean happiness after winning Risk)
- especially inaccurate when looking at play 1 and 2 separately (for win happiness)

###re

```{r Loss Domain, Risky Choice, Win vs Lose Happiness}
result <- winvloss_happy(happyData12, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test #signiifcantly happier after winning a risky choice in loss domain

#z-scored
result <- winvloss_z_happy(happyData12, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test #signiifcantly happier after winning a risky choice in loss domain

result <- winvloss_happy_GAD(happyData12, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus #again, model is doing well in loss domain
result$wilcox_test_gad_less6

#z-scored
result <- winvloss_z_happy_GAD(happyData12, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus #again, model is doing well in loss domain
result$wilcox_test_gad_less6

# play 1
result <- winvloss_happy(play1, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test #signiifcantly happier after winning a risky choice in loss domain

result <- winvloss_happy_GAD(play1, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus #again, model is doing well in loss domain
result$wilcox_test_gad_less6

# play 2
result <- winvloss_happy(play2, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test #signiifcantly happier after winning a risky choice in loss domain

result <- winvloss_happy_GAD(play2, "Loss", "Risky")
result$summary_long
result$plot
result$wilcox_test_gad6plus #again, model is doing well in loss domain
result$wilcox_test_gad_less6
```
- model does well predicting happiness in loss domain, when winning an risky choice vs loing a risky choice

```{r Gain Domain, Safe Choice, Win vs Lose Happiness}
result <- winvloss_happy(happyData12, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test #again, model is predicting that people shoud be happier after winning, but the data is not showing that

#z-scored
result <- winvloss_z_happy(happyData12, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test 

result <- winvloss_happy_GAD(happyData12, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus 
result$wilcox_test_gad_less6

#z-scored
result <- winvloss_z_happy_GAD(happyData12, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus 
result$wilcox_test_gad_less6

# looks like model is off for wins, but actually more accurate for the high anxiety people

# play 1
result <- winvloss_happy(play1, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test #again, model is predicting that people shoud be happier after winning, but the data is not showing that

result <- winvloss_happy_GAD(play1, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus 
result$wilcox_test_gad_less6

# play 2
result <- winvloss_happy(play2, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test #again, model is predicting that people shoud be happier after winning, but the data is not showing that

result <- winvloss_happy_GAD(play2, "Gain", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus 
result$wilcox_test_gad_less6
```
```{r Loss Domain, Safe Choice, Win vs Lose Happiness}
result <- winvloss_happy(happyData12, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test #significantly happier after winning in loss domains 

# z-scored

result <- winvloss_z_happy(happyData12, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test #


result <- winvloss_happy_GAD(happyData12, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus #both groups significantly happier after winning a risky choice in loss domain
result$wilcox_test_gad_less6

# z-scored
result <- winvloss_z_happy_GAD(happyData12, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus #both groups significantly happier after winning a risky choice in loss domain
result$wilcox_test_gad_less6

# play 1
result <- winvloss_happy(play1, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test #significantly happier after winning in loss domains 

result <- winvloss_happy_GAD(play1, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus #both groups significantly happier after winning a risky choice in loss domain
result$wilcox_test_gad_less6

# play 2
result <- winvloss_happy(play2, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test #significantly happier after winning in loss domains 

result <- winvloss_happy_GAD(play2, "Loss", "Safe")
result$summary_long
result$plot
result$wilcox_test_gad6plus #both groups significantly happier after winning a risky choice in loss domain
result$wilcox_test_gad_less6
```
- happiness model seems to be capturing happiness in loss domains quite well, but not in gain domains

```{r Happiness Risky vs Safe Choice, Overall}
riskyvsafe_happy(happyData12, "Overall")
riskyvsafe_happy(happyData12, "Win")
```





## Future Information and Happiness

```{r Future Information}
happyData12 <- happyData12 %>%
  group_by(userKey) %>%
  arrange(userKey, PlayNo, TrialNumber) %>%
  ungroup()

```

```{r Next Island infomartion}
result<-next_island_happy(happyData12)
result$plot
result$summary_table

#z-scored
result<-next_island_z_happy(happyData12)
result$plot
result$summary_table

result<-next_island_happy_GAD(happyData12)
result$plot
result$summary_table

#z-scored
result<-next_island_z_happy_GAD(happyData12)
result$plot
result$summary_table
# model predicts average happiness based on next island quite well

result <- next_last_island_happy(happyData12)
result$plot
result$summary_table

#z-scored
result <- next_last_island_z_happy(happyData12)
result$plot
result$summary_table

result <- next_last_island_happy_GAD(happyData12)
result$plot
result$summary_table


result <- next_last_current_island_happy(happyData12)
result$plot
result$summary_table

result <- next_last_current_island_happy_GAD(happyData12)
result$plot
result$summary_table
```
- people are happier when the current trial is a gain trial, compared to loss
- but future information doesn't seem to make a difference - if anything, looks like people are happier when future islands are loss islands?

## Happiness Based on EV (regardless of choice)



## Happiness Based on Alterate Option

```{r  % Risky Choices based on EV of risky option relative to  safe option}

happyData12 <- happyData12 %>%
  mutate(SafeEV = ((SafeProb*SafeValue)+((1-SafeProb)*0))/2,
         RiskyEV = ((RiskyProb*RiskyValue)+((1-RiskyProb)*0))/2)

happyData12 <- happyData12 %>%
  mutate(RelEV = ifelse(abs(RiskyEV) >= 2 * abs(SafeEV), "High",
                 ifelse(abs(RiskyEV) > abs(SafeEV) & abs(RiskyEV) < 2 * abs(SafeEV), "Medium",
                 ifelse(abs(RiskyEV) == abs(SafeEV), "Equal", "Low"))))

result <- risky_choice_EVs(happyData12)
print(result$plot)
result$kruskal_test_gain
result$kruskal_test_loss

relEV_counts <- happyData12 %>%
  group_by(RelEV) %>%
  summarise(count = n())

# Print the counts
print(relEV_counts)
```

```{r  % Risky Choices based on Probability}
result <- risky_choice_probs(happyData12)
print(result$plot)
print(result$kruskal_test_gain)
print(result$kruskal_test_loss)

```


```{r % Risky Choices Split by GAD}
result <- risky_choice_EVs_GAD(happyData12)
print(result$plot)
print(result$kruskal_gain_GAD_less_6) # near significant differences in gain domain for % risk taking across different EVs
print(result$kruskal_loss_GAD_less_6)
print(result$kruskal_gain_GAD_6_plus)
print(result$kruskal_loss_GAD_6_plus)
```

```{r Mean Happiness (not backfilled) across different EV options}

result <- mean_happiness_by_RelEV(happyData12)
print(result$plot)


result <- mean_happiness_by_RelEV_GAD(happyData12)
print(result$plot)

# follow-up kruskal test to see if there is a signi
result<-kruskal_happiness_by_RelEV_GAD(happyData12)
print(result$kruskal_gain_all) #n.s kruskal in gain domain across all
print(result$kruskal_loss_all) #significant differences in loss domain
print(result$kruskal_gain_GAD_less_6)
print(result$kruskal_loss_GAD_less_6) #in loss domain signficant differences in happiness across EV values among GAD < 6 participants
print(result$kruskal_gain_GAD_6_plus) 
print(result$kruskal_loss_GAD_6_plus) 
print(result$dunn_result_GAD_less_6)
print(result$dunn_result_GAD_6_plus)

```

```{r Mean Happiness Across Different Probabilities}
# risky prob
result <- mean_happiness_by_RiskyProb_GAD(happyData12)
print(result$plot)
print(result$kruskal_tests$kruskal_gain_GAD_6_plus) #n.s.
print(result$kruskal_tests$kruskal_gain_GAD_less_6) #m.s.
print(result$kruskal_tests$kruskal_loss_GAD_6_plus) # p=0.0047
print(result$kruskal_tests$kruskal_loss_GAD_less_6) # p<.0001
```

```{r}
result <- mean_happiness_by_RelEV_GAD_Outcome(happyData12)
print(result$plot)
print(result$kruskal_tests$kruskal_gain_win_GAD_6_plus) #n.s
print(result$kruskal_tests$kruskal_gain_win_GAD_less_6) #n.s
print(result$kruskal_tests$kruskal_gain_loss_GAD_6_plus) #n.s
print(result$kruskal_tests$kruskal_gain_loss_GAD_less_6) #n.s
print(result$kruskal_tests$kruskal_loss_win_GAD_6_plus) #n.s
print(result$kruskal_tests$kruskal_loss_win_GAD_less_6) #n.s
print(result$kruskal_tests$kruskal_loss_loss_GAD_6_plus) #n.s
print(result$kruskal_tests$kruskal_loss_loss_GAD_less_6) #n.s

# no significant overall differences 
```


